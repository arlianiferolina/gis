{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}{{ perumahan.name }} - WebGIS Perumahan{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Beranda</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'core:perumahan_list' %}">Perumahan</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ perumahan.name }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <h1>{{ perumahan.name }}</h1>
            <p class="lead">{{ perumahan.description }}</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            {% if perumahan.photo %}
            <img src="{{ perumahan.photo.url }}" class="img-fluid rounded" alt="{{ perumahan.name }}">
            {% endif %}
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Informasi Perumahan</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Harga:</strong> 
                            <span class="text-success fw-bold">Rp {{ perumahan.price|intcomma }}</span>
                        </li>
                        <li class="list-group-item">
                            <strong>Alamat:</strong> {{ perumahan.address }}
                        </li>
                        <li class="list-group-item">
                            <strong>Status:</strong> 
                            {% if perumahan.status == 'available' %}
                                <span class="badge bg-success">Tersedia</span>
                            {% else %}
                                <span class="badge bg-danger">Terjual</span>
                            {% endif %}
                        </li>
                        <li class="list-group-item">
                            <strong>Dibuat pada:</strong> {{ perumahan.created_at|date:"d M Y" }}
                        </li>
                    </ul>
                    
                    {% if perumahan.facilities %}
                    <h6 class="mt-3">Fasilitas:</h6>
                    <ul>
                        {% for facility in perumahan.facilities %}
                        <li>{{ facility }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Lokasi Perumahan</h5>
                    <div id="map" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'core:perumahan_list' %}" class="btn btn-primary">Kembali ke Daftar Perumahan</a>
            <button class="btn btn-success">Hubungi Penjual</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get location data from Django template
        var lat = parseFloat("{{ perumahan.location.lat }}");
        var lng = parseFloat("{{ perumahan.location.lng }}");
        
        // Initialize map for detail page
        var map = L.map('map').setView([lat, lng], 15);
        
        // Add OpenStreetMap tiles
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });
        
        // Add Satellite layer
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });
        
        // Add both layers to map with OSM as default
        osmLayer.addTo(map);
        
        // Add layer control for base layers
        var baseMaps = {
            "OpenStreetMap": osmLayer,
            "Satelit": satelliteLayer
        };
        
        L.control.layers(baseMaps).addTo(map);
        
        // Add marker for perumahan location
        var marker = L.marker([lat, lng]).addTo(map)
            .bindPopup('<b>{{ perumahan.name }}</b><br>Harga: Rp {{ perumahan.price }}');
            
        // If polygon exists, add it to the map
        /*
        {% if perumahan.polygon %}
        var polygonCoords = {{ perumahan.polygon.coordinates|safe }};
        var polygon = L.polygon(polygonCoords, {color: 'blue'}).addTo(map);
        {% endif %}
        */
    });
</script>
{% endblock %}